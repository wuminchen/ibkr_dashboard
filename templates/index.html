{% extends 'base.html' %}

{# --- 页面主体内容 --- #}
{% block title %}IBKR 高级分析仪表盘{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        padding: 0;
        background-color: #f0f2f5;
    }
    .dashboard-container {
        display: flex;
        height: 100vh;
    }
    /* --- 左侧边栏 --- */
    .sidebar {
        width: 320px;
        background-color: #fff;
        padding: 24px;
        box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }
    .sidebar-header {
        text-align: center;
        margin-bottom: 32px;
    }
    .sidebar-header h1 {
        font-size: 1.5rem;
        color: var(--primary-color);
    }
    .sidebar-header .fas {
        margin-right: 10px;
    }
    .sidebar .account-switcher {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 32px;
    }
    .sidebar .btn-account {
        width: 100%;
        text-align: left;
        border-radius: 6px;
    }
    .summary-section h3 {
        font-size: 1.1rem;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 16px;
    }
    .summary-grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .summary-item {
        border-left: none;
        padding: 0;
    }
    /* --- 右侧主内容区 --- */
    .main-content {
        flex-grow: 1;
        padding: 32px;
        overflow-y: auto;
    }
    .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    .main-header h2 {
        font-size: 2rem;
        margin: 0;
        color: #111;
    }
    .main-header .timestamp {
        font-size: 1rem;
        color: #666;
    }
    /* --- 可视化图表卡片 --- */
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 32px;
    }
    .chart-card {
        background-color: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        height: 350px; 
    }
    .chart-card h4 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.1rem;
        color: #333;
    }
    /* 表格容器样式 */
    .positions-section .account-card {
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        padding: 24px 32px;
        overflow: hidden;
    }
    /* --- 表格排序样式 --- */
    th[data-sortable="true"] { cursor: pointer; position: relative; user-select: none; }
    th[data-sortable="true"]::after { content: ''; position: absolute; right: 8px; top: 50%; margin-top: -8px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; opacity: 0.3; }
    th[data-sortable="true"]:not([data-sort-direction])::after { content: ' \2195'; margin-top: -12px; }
    th[data-sortable="true"][data-sort-direction="asc"]::after { border-bottom: 6px solid #333; opacity: 1; }
    th[data-sortable="true"][data-sort-direction="desc"]::after { border-top: 6px solid #333; opacity: 1; }

    /* --- 修改：红涨绿跌高亮动画 --- */
    @keyframes highlight-red-fade {
        from { background-color: rgba(216, 0, 12, 0.3); } /* 红色背景 */
        to { background-color: transparent; }
    }
    .highlight-up {
        animation: highlight-red-fade 1.5s ease-out;
    }

    @keyframes highlight-green-fade {
        from { background-color: rgba(45, 125, 50, 0.3); } /* 绿色背景 */
        to { background-color: transparent; }
    }
    .highlight-down {
        animation: highlight-green-fade 1.5s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h1><i class="fas fa-chart-pie"></i>分析仪表盘</h1>
        </div>
        <div class="account-switcher">
            <button class="btn-account active" data-target-account="all">所有账户 (聚合)</button>
            {% for account_id in all_data.keys() %}
            <button class="btn-account" data-target-account="{{ account_id }}">{{ account_id }}</button>
            {% endfor %}
        </div>
        <div class="summary-section">
            <h3><i class="fas fa-file-invoice-dollar"></i> 核心指标</h3>
            <div id="summary-view-all" class="summary-grid" data-cash="{{ aggregated_data.summary.cash }}">
                {% if aggregated_data %}
                <div class="summary-item"><span class="summary-label">总净清算价值</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.net_liquidation) }} {{ aggregated_data.summary.currency }}</span></div>
                <div class="summary-item"><span class="summary-label">当日总未实现盈亏</span><span id="daily-unrealized-pnl-all" class="summary-value">--.--</span></div>
                <div class="summary-item"><span class="summary-label">今日总已实现盈亏</span><span class="summary-value {% if aggregated_data.summary.realized_pnl > 0 %}pnl-positive{% elif aggregated_data.summary.realized_pnl < 0 %}pnl-negative{% endif %}">{{ "%.2f"|format(aggregated_data.summary.realized_pnl) }}</span></div>
                <div class="summary-item"><span class="summary-label">总现金余额</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.cash) }}</span></div>
                <div class="summary-item"><span class="summary-label">总购买力</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.buying_power) }}</span></div>
                {% endif %}
            </div>
            {% for account_id, data in all_data.items() %}
            <div id="summary-view-{{ account_id }}" class="summary-grid" style="display: none;" data-cash="{{ data.summary.cash }}">
                <div class="summary-item"><span class="summary-label">净清算价值</span><span class="summary-value">{{ "%.2f"|format(data.summary.net_liquidation) }} {{ data.summary.currency }}</span></div>
                <div class="summary-item"><span class="summary-label">当日未实现盈亏</span><span id="daily-unrealized-pnl-{{ account_id }}" class="summary-value">--.--</span></div>
                <div class="summary-item"><span class="summary-label">今日已实现盈亏</span><span class="summary-value {% if data.summary.realized_pnl > 0 %}pnl-positive{% elif data.summary.realized_pnl < 0 %}pnl-negative{% endif %}">{{ "%.2f"|format(data.summary.realized_pnl) }}</span></div>
                <div class="summary-item"><span class="summary-label">现金余额</span><span class="summary-value">{{ "%.2f"|format(data.summary.cash) }}</span></div>
                <div class="summary-item"><span class="summary-label">购买力</span><span class="summary-value">{{ "%.2f"|format(data.summary.buying_power) }}</span></div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="main-content">
        <div class="main-header">
            <h2 id="main-content-title">所有账户 (聚合视图)</h2>
            <p class="timestamp">上次更新: <span id="last-updated">--:--:--</span></p>
        </div>
        <div class="charts-grid">
            <div class="chart-card">
                <h4><i class="fas fa-chart-line"></i> 实时净清算价值 (最近20次更新)</h4>
                <canvas id="net-liq-history-chart"></canvas>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> 盈亏影响 Top 5</h4>
                <canvas id="pnl-barchart"></canvas>
            </div>
        </div>
        <div class="positions-section">
            <div id="table-view-all" class="account-card" data-account-id="all">
                 {% if aggregated_data.positions %}
                <table class="positions-table sortable-table">
                    <thead><tr><th data-sortable="true" data-type="text">产品</th><th data-sortable="true" data-type="text">资产类别</th><th data-sortable="true" data-type="numeric">总数量</th><th data-sortable="true" data-type="numeric">加权平均成本</th><th data-sortable="true" data-type="numeric">总持仓成本</th><th data-sortable="true" data-type="numeric">当前市价</th><th data-sortable="true" data-type="numeric">总市值</th><th data-sortable="true" data-type="numeric">总未实现盈亏</th><th data-sortable="true" data-type="numeric">盈亏 (%)</th><th data-sortable="true" data-type="numeric">当日总盈亏</th><th>持仓分布</th></tr></thead>
                    <tbody>
                        {% for pos in aggregated_data.positions %}
                        <tr data-conid="{{ pos.conid }}" data-position="{{ pos.position }}" data-avgcost="{{ pos.avgCost }}" data-costbasis="{{ pos.costBasis }}" data-assetclass="{{ pos.assetClass }}" data-contractdesc="{{ pos.contractDesc }}">
                            <td><strong>{{ pos.contractDesc }}</strong></td><td>{{ pos.assetClass }}</td><td>{{ pos.position }}</td><td>{{ "%.2f"|format(pos.avgCost) }}</td><td>{{ "%.2f"|format(pos.costBasis) }}</td><td id="price-{{ pos.conid }}" class="updating">--.--</td><td id="marketValue-{{ pos.conid }}" class="updating">--.--</td><td id="pnl-{{ pos.conid }}" class="updating">--.--</td><td id="pnlPercent-{{ pos.conid }}" class="updating">--.--%</td><td id="dailyPnl-{{ pos.conid }}" class="updating">--.--</td>
                            <td class="holdings-breakdown">{% for acc_id, qty in pos.holdings_breakdown.items() %}<span>{{ acc_id }}: <strong>{{ qty }}</strong></span>{% endfor %}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}<p>当前没有持仓。</p>{% endif %}
            </div>
            {% for account_id, data in all_data.items() %}
            <div id="table-view-{{ account_id }}" class="account-card" data-account-id="{{ account_id }}" style="display: none;">
                {% if data.positions %}
                <table class="positions-table sortable-table">
                    <thead><tr><th data-sortable="true" data-type="text">产品</th><th data-sortable="true" data-type="text">资产类别</th><th data-sortable="true" data-type="numeric">数量</th><th data-sortable="true" data-type="numeric">平均成本</th><th data-sortable="true" data-type="numeric">持仓成本</th><th data-sortable="true" data-type="numeric">当前市价</th><th data-sortable="true" data-type="numeric">总市值</th><th data-sortable="true" data-type="numeric">未实现盈亏</th><th data-sortable="true" data-type="numeric">盈亏 (%)</th><th data-sortable="true" data-type="numeric">当日盈亏</th><th>货币</th></tr></thead>
                    <tbody>
                         {% for pos in data.positions %}
                        <tr data-conid="{{ pos.conid }}" data-position="{{ pos.position }}" data-avgcost="{{ pos.avgCost }}" data-costbasis="{{ pos.costBasis }}" data-assetclass="{{ pos.assetClass }}" data-contractdesc="{{ pos.contractDesc }}">
                            <td><strong>{{ pos.contractDesc }}</strong></td><td>{{ pos.assetClass }}</td><td>{{ pos.position }}</td><td>{{ "%.2f"|format(pos.avgCost) }}</td><td>{{ "%.2f"|format(pos.costBasis) }}</td><td id="price-{{ pos.conid }}" class="updating">--.--</td><td id="marketValue-{{ pos.conid }}" class="updating">--.--</td><td id="pnl-{{ pos.conid }}" class="updating">--.--</td><td id="pnlPercent-{{ pos.conid }}" class="updating">--.--%</td><td id="dailyPnl-{{ pos.conid }}" class="updating">--.--</td><td>{{ pos.currency }}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}<p>此账户当前没有持仓。</p>{% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}


{# --- 页面专属的 JavaScript --- #}
{% block scripts %}
<script>
    const UPDATE_INTERVAL_MS = 3000; // 更新间隔（毫秒），3秒

    let chartInstances = {};
    let netLiqHistory = {};
    const MAX_HISTORY_POINTS = 300;
    let accountCashBalances = {};

    // *** 修改：改造数字滚动动画函数，以支持红涨绿跌 ***
    function animateValue(element, start, end, duration) {
        if (!element) return;
        // 如果数值没有变化，则不执行动画
        if (start === end) return;
        
        // 1. 移除所有可能存在的高亮类，以便动画可以重复触发
        element.classList.remove('highlight-up', 'highlight-down');
        void element.offsetWidth; // 强制浏览器重绘，这是让动画重复播放的关键技巧

        // 2. 根据涨跌情况，添加对应的高亮类
        if (end > start) {
            element.classList.add('highlight-up'); // 上涨，应用红色高亮
        } else {
            element.classList.add('highlight-down'); // 下跌，应用绿色高亮
        }

        const range = end - start;
        const minimumFractionDigits = 2;
        const maximumFractionDigits = 2;
        let startTime = null;

        function step(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / duration, 1);
            const currentVal = start + progress * range;
            element.textContent = currentVal.toLocaleString('en-US', {
                minimumFractionDigits: minimumFractionDigits,
                maximumFractionDigits: maximumFractionDigits
            });
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        }
        window.requestAnimationFrame(step);
    }
    
    function updatePnlCell(cell, pnlValue, oldPnlValue) {
        if (!cell) return;
        let pnlIcon = '';
        if (pnlValue > 0.001) { cell.className = 'pnl-positive'; pnlIcon = '<i class="fas fa-arrow-up pnl-icon"></i>'; } 
        else if (pnlValue < -0.001) { cell.className = 'pnl-negative'; pnlIcon = '<i class="fas fa-arrow-down pnl-icon"></i>'; } 
        else { cell.className = ''; pnlIcon = '<i class="fas fa-minus pnl-icon"></i>'; }
        
        const valueSpan = cell.querySelector('.pnl-value') || document.createElement('span');
        valueSpan.className = 'pnl-value';
        
        // 此处的动画将由 animateValue 内部逻辑自动处理红绿高亮
        const startValue = oldPnlValue !== undefined ? oldPnlValue : pnlValue;
        animateValue(valueSpan, startValue, pnlValue, 500);

        cell.innerHTML = pnlIcon;
        cell.appendChild(valueSpan);
    }

    function updatePrices() {
        const allRows = Array.from(document.querySelectorAll('tr[data-conid]'));
        if (allRows.length === 0) return;
        const allConids = [...new Set(allRows.map(row => row.dataset.conid))];

        fetch(`/api/prices?conids=${allConids.join(',')}`)
            .then(response => response.json())
            .then(priceData => {
                const pnlByAccount = {};
                Object.keys(accountCashBalances).forEach(accId => pnlByAccount[accId] = 0);

                allRows.forEach(row => {
                    const conid = row.dataset.conid;
                    const priceInfo = priceData[conid];
                    if (!priceInfo || isNaN(parseFloat(priceInfo.price))) return;

                    const priceCell = row.querySelector(`#price-${conid}`);
                    const marketValueCell = row.querySelector(`#marketValue-${conid}`);
                    const pnlCell = row.querySelector(`#pnl-${conid}`);
                    const dailyPnlCell = row.querySelector(`#dailyPnl-${conid}`);

                    const oldPrice = parseFloat(priceCell.textContent.replace(/,/g, '')) || 0;
                    const oldMarketValue = parseFloat(marketValueCell.textContent.replace(/,/g, '')) || 0;
                    const oldPnl = parseFloat(pnlCell.querySelector('.pnl-value')?.textContent.replace(/,/g, '')) || 0;
                    const oldDailyPnl = parseFloat(dailyPnlCell.querySelector('.pnl-value')?.textContent.replace(/,/g, '')) || 0;
                    
                    const latestPrice = parseFloat(priceInfo.price);
                    const dailyChange = parseFloat(priceInfo.change);
                    const position = parseFloat(row.dataset.position);
                    const costBasis = parseFloat(row.dataset.costbasis);
                    const marketValue = latestPrice * position;
                    const unrealizedPnl = marketValue - costBasis;
                    const dailyPnl = isNaN(dailyChange) ? 0 : dailyChange * position;
                    const pnlPercent = (costBasis !== 0) ? (unrealizedPnl / costBasis) * 100 : 0;
                    
                    animateValue(priceCell, oldPrice, latestPrice, 500);
                    animateValue(marketValueCell, oldMarketValue, marketValue, 500);
                    updatePnlCell(pnlCell, unrealizedPnl, oldPnl);
                    updatePnlCell(dailyPnlCell, dailyPnl, oldDailyPnl);
                    
                    const pnlPercentCell = row.querySelector(`#pnlPercent-${conid}`);
                    pnlPercentCell.className = unrealizedPnl > 0.001 ? 'pnl-positive' : (unrealizedPnl < -0.001 ? 'pnl-negative' : '');
                    pnlPercentCell.textContent = pnlPercent.toFixed(2) + '%';
                    
                    const accountId = row.closest('.account-card').dataset.accountId;
                    if (pnlByAccount.hasOwnProperty(accountId)) { pnlByAccount[accountId] += dailyPnl; }
                    if (accountId !== 'all') { pnlByAccount['all'] += dailyPnl; }
                });

                for (const accountId in pnlByAccount) {
                    const pnlSummaryCell = document.querySelector(`#daily-unrealized-pnl-${accountId}`);
                    if (pnlSummaryCell) {
                        const oldPnl = parseFloat(pnlSummaryCell.textContent.replace(/,/g, '')) || 0;
                        const pnlValue = pnlByAccount[accountId];
                        pnlSummaryCell.className = pnlValue > 0.001 ? 'summary-value pnl-positive' : (pnlValue < -0.001 ? 'summary-value pnl-negative' : 'summary-value');
                        animateValue(pnlSummaryCell, oldPnl, pnlValue, 500);
                    }
                }

                const newMarketValues = {};
                Object.keys(accountCashBalances).forEach(accId => newMarketValues[accId] = 0);
                document.querySelectorAll('.positions-section .account-card').forEach(card => {
                    const accId = card.dataset.accountId;
                    let totalMarketValue = 0;
                    card.querySelectorAll('tr[data-conid]').forEach(row => {
                        totalMarketValue += parseFloat(row.querySelector(`td:nth-child(7)`).textContent.replace(/,/g, '')) || 0;
                    });
                    newMarketValues[accId] = totalMarketValue;
                });
                
                newMarketValues['all'] = Object.entries(newMarketValues)
                    .filter(([key]) => key !== 'all')
                    .reduce((sum, [, value]) => sum + value, 0);

                for (const accountId in newMarketValues) {
                    const cash = accountCashBalances[accountId] || 0;
                    const currentNetLiq = newMarketValues[accountId] + cash;
                    if (!netLiqHistory[accountId]) netLiqHistory[accountId] = [];
                    netLiqHistory[accountId].push({ time: new Date(), value: currentNetLiq });
                    if (netLiqHistory[accountId].length > MAX_HISTORY_POINTS) {
                        netLiqHistory[accountId].shift();
                    }
                }

                const activeTable = document.querySelector('.positions-section .account-card:not([style*="display: none"])');
                if (activeTable) {
                    const activeRows = Array.from(activeTable.querySelectorAll('tr[data-conid]'));
                    const chartData = activeRows.map(row => ({
                        contractDesc: row.dataset.contractdesc,
                        unrealizedPnl: parseFloat(row.querySelector(`td:nth-child(8)`).querySelector('.pnl-value')?.textContent.replace(/,/g, '')) || 0
                    }));
                    renderCharts(chartData);
                }

                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            }).catch(error => console.error('更新价格失败:', error));
    }
    
    function renderCharts(pnlData) {
        const activeAccountId = document.querySelector('.btn-account.active').dataset.targetAccount;
        const history = netLiqHistory[activeAccountId] || [];
        
        renderNetLiqHistoryChart(history);

        const sortedByAbsPnl = [...pnlData].sort((a, b) => Math.abs(b.unrealizedPnl) - Math.abs(a.unrealizedPnl));
        const pnlChartData = sortedByAbsPnl.slice(0, 5);
        renderPnlBarChart(pnlChartData);
    }
    
    function renderNetLiqHistoryChart(history) {
        const ctx = document.getElementById('net-liq-history-chart');
        if (!ctx) return;

        if (chartInstances.netLiq) {
            chartInstances.netLiq.data.labels = history.map(p => p.time.toLocaleTimeString());
            chartInstances.netLiq.data.datasets[0].data = history.map(p => p.value);
            chartInstances.netLiq.update('none');
        } else {
            chartInstances.netLiq = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(p => p.time.toLocaleTimeString()),
                    datasets: [{
                        label: '净清算价值',
                        data: history.map(p => p.value),
                        borderColor: 'var(--primary-color)',
                        backgroundColor: 'rgba(0, 90, 156, 0.1)',
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { callback: (value) => value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) } }
                    }
                }
            });
        }
    }

    function renderPnlBarChart(data) {
        const ctx = document.getElementById('pnl-barchart');
        if (!ctx) return;
        
        const labels = data.map(p => p.contractDesc);
        const values = data.map(p => p.unrealizedPnl);
        const bgColors = data.map(p => p.unrealizedPnl >= 0 ? 'rgba(216, 0, 12, 0.7)' : 'rgba(45, 125, 50, 0.7)'); // 红涨绿跌

        if (chartInstances.pnl) {
            chartInstances.pnl.data.labels = labels;
            chartInstances.pnl.data.datasets[0].data = values;
            chartInstances.pnl.data.datasets[0].backgroundColor = bgColors;
            chartInstances.pnl.update('none');
        } else {
            chartInstances.pnl = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '未实现盈亏', data: values,
                        backgroundColor: bgColors
                    }]
                },
                options: { 
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: {
                         x: { ticks: { color: (c) => c.tick.value >= 0 ? '#D8000C' : '#2E7D32' }}
                    }
                }
            });
        }
    }

    // --- 以下函数无需改动 ---
    function switchAccountView(targetAccountId) {
        document.getElementById('main-content-title').textContent = document.querySelector(`.btn-account[data-target-account="${targetAccountId}"]`).textContent;
        document.querySelectorAll('.summary-grid').forEach(grid => grid.style.display = grid.id === `summary-view-${targetAccountId}` ? 'flex' : 'none');
        document.querySelectorAll('.positions-section .account-card').forEach(card => card.style.display = (card.dataset.accountId === targetAccountId) ? 'block' : 'none');
        document.querySelectorAll('.btn-account').forEach(button => button.classList.toggle('active', button.dataset.targetAccount === targetAccountId));
        // 清空图表实例，以便在切换账户时强制重新创建，避免数据混淆
        Object.values(chartInstances).forEach(chart => chart.destroy());
        chartInstances = {};
        updatePrices();
    }
    
    function makeTablesSortable() {
        document.querySelectorAll('.sortable-table').forEach(table => {
            let headers = table.querySelectorAll('th[data-sortable="true"]');
            headers.forEach((header, index) => header.addEventListener('click', () => sortColumn(table, index)));
        });
    }

    function sortColumn(table, columnIndex) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const header = table.querySelector(`thead th:nth-child(${columnIndex + 1})`);
        const type = header.dataset.type;
        const currentDirection = header.dataset.sortDirection || 'desc';
        const newDirection = currentDirection === 'desc' ? 'asc' : 'desc';
        table.querySelectorAll('th[data-sortable="true"]').forEach(h => h.removeAttribute('data-sort-direction'));
        header.dataset.sortDirection = newDirection;
        const sortedRows = rows.sort((a, b) => {
            const cellA = a.querySelector(`td:nth-child(${columnIndex + 1})`).textContent.trim();
            const cellB = b.querySelector(`td:nth-child(${columnIndex + 1})`).textContent.trim();
            let valA, valB;
            if (type === 'numeric') {
                valA = parseFloat(cellA.replace(/[,%$]/g, '')) || -Infinity;
                valB = parseFloat(cellB.replace(/[,%$]/g, '')) || -Infinity;
            } else { valA = cellA; valB = cellB; }
            if (valA > valB) return 1; if (valA < valB) return -1; return 0;
        });
        if (newDirection === 'desc') sortedRows.reverse();
        tbody.innerHTML = '';
        sortedRows.forEach(row => tbody.appendChild(row));
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.summary-grid[id^="summary-view-"]').forEach(grid => {
            const accountId = grid.id.replace('summary-view-', '');
            accountCashBalances[accountId] = parseFloat(grid.dataset.cash) || 0;
            netLiqHistory[accountId] = [];
        });
        document.querySelectorAll('.btn-account').forEach(button => {
            button.addEventListener('click', (event) => switchAccountView(event.currentTarget.dataset.targetAccount));
        });
        makeTablesSortable();
        switchAccountView('all');
        setInterval(updatePrices, UPDATE_INTERVAL_MS);
    });
</script>
{% endblock %}