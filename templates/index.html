{% extends 'base.html' %}

{# --- 宏定义：渲染【单个】账户卡片 --- #}
{% macro render_account_card(account_id, data) %}
<div class="account-card" style="display: none;" data-account-id="{{ account_id }}">
    <h2><i class="fas fa-wallet"></i> 账户: {{ account_id }}</h2>
    <div class="summary-grid">
        <div class="summary-item"><span class="summary-label">净清算价值</span><span class="summary-value">{{ "%.2f"|format(data.summary.net_liquidation) }} {{ data.summary.currency }}</span></div>
        <div class="summary-item"><span class="summary-label">当日未实现盈亏</span><span id="daily-unrealized-pnl-{{ account_id }}" class="summary-value">--.--</span></div>
        <div class="summary-item"><span class="summary-label">今日已实现盈亏</span><span class="summary-value {% if data.summary.realized_pnl > 0 %}pnl-positive{% elif data.summary.realized_pnl < 0 %}pnl-negative{% endif %}">{{ "%.2f"|format(data.summary.realized_pnl) }}</span></div>
        <div class="summary-item"><span class="summary-label">现金余额</span><span class="summary-value">{{ "%.2f"|format(data.summary.cash) }}</span></div>
        <div class="summary-item"><span class="summary-label">购买力</span><span class="summary-value">{{ "%.2f"|format(data.summary.buying_power) }}</span></div>
    </div>
    {% if data.positions %}
        <div style="overflow-x: auto;">
            <table class="positions-table">
                <thead>
                    <tr><th>产品</th><th>资产类别</th><th>数量</th><th>平均成本</th><th>持仓成本</th><th>当前市价</th><th>总市值</th><th>未实现盈亏</th><th>盈亏 (%)</th><th>当日盈亏</th><th>货币</th></tr>
                </thead>
                <tbody>
                    {% for pos in data.positions %}
                        <tr data-conid="{{ pos.conid }}" data-position="{{ pos.position }}" data-avgcost="{{ pos.avgCost }}" data-costbasis="{{ pos.costBasis }}">
                            <td><strong>{{ pos.contractDesc }}</strong></td><td>{{ pos.assetClass }}</td><td>{{ pos.position }}</td><td>{{ "%.2f"|format(pos.avgCost) }}</td><td>{{ "%.2f"|format(pos.costBasis) }}</td><td id="price-{{ pos.conid }}" class="updating">--.--</td><td id="marketValue-{{ pos.conid }}" class="updating">--.--</td><td id="pnl-{{ pos.conid }}" class="updating">--.--</td><td id="pnlPercent-{{ pos.conid }}" class="updating">--.--%</td><td id="dailyPnl-{{ pos.conid }}" class="updating">--.--</td><td>{{ pos.currency }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}<p>此账户当前没有持仓。</p>{% endif %}
</div>
{% endmacro %}


{# --- 页面主体内容 --- #}
{% block title %}IBKR 实时持仓仪表盘{% endblock %}

{% block content %}
<div class="header">
    <h1><i class="fas fa-chart-line"></i> IBKR 实时持仓仪表盘</h1>
    <p class="timestamp">上次更新: <span id="last-updated">--:--:--</span></p>
</div>

<div class="account-switcher">
    <button class="btn-account active" data-target-account="all">所有账户 (聚合)</button>
    {% for account_id in all_data.keys() %}
    <button class="btn-account" data-target-account="{{ account_id }}">{{ account_id }}</button>
    {% endfor %}
</div>

<div id="all-accounts-view" class="account-card" data-account-id="all">
    <h2><i class="fas fa-globe"></i> 所有账户 (聚合视图)</h2>
    {% if aggregated_data %}
    <div class="summary-grid">
        <div class="summary-item"><span class="summary-label">总净清算价值</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.net_liquidation) }} {{ aggregated_data.summary.currency }}</span></div>
        <div class="summary-item"><span class="summary-label">当日总未实现盈亏</span><span id="daily-unrealized-pnl-all" class="summary-value">--.--</span></div>
        <div class="summary-item"><span class="summary-label">今日总已实现盈亏</span><span class="summary-value {% if aggregated_data.summary.realized_pnl > 0 %}pnl-positive{% elif aggregated_data.summary.realized_pnl < 0 %}pnl-negative{% endif %}">{{ "%.2f"|format(aggregated_data.summary.realized_pnl) }}</span></div>
        <div class="summary-item"><span class="summary-label">总现金余额</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.cash) }}</span></div>
        <div class="summary-item"><span class="summary-label">总购买力</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.buying_power) }}</span></div>
    </div>
    {% if aggregated_data.positions %}
        <div style="overflow-x: auto;">
            <table class="positions-table">
                <thead>
                    <tr><th>产品</th><th>资产类别</th><th>总数量</th><th>加权平均成本</th><th>总持仓成本</th><th>当前市价</th><th>总市值</th><th>总未实现盈亏</th><th>盈亏 (%)</th><th>当日总盈亏</th><th>持仓分布</th></tr>
                </thead>
                <tbody>
                    {% for pos in aggregated_data.positions %}
                        <tr data-conid="{{ pos.conid }}" data-position="{{ pos.position }}" data-avgcost="{{ pos.avgCost }}" data-costbasis="{{ pos.costBasis }}">
                            <td><strong>{{ pos.contractDesc }}</strong></td><td>{{ pos.assetClass }}</td><td>{{ pos.position }}</td><td>{{ "%.2f"|format(pos.avgCost) }}</td><td>{{ "%.2f"|format(pos.costBasis) }}</td><td id="price-{{ pos.conid }}" class="updating">--.--</td><td id="marketValue-{{ pos.conid }}" class="updating">--.--</td><td id="pnl-{{ pos.conid }}" class="updating">--.--</td><td id="pnlPercent-{{ pos.conid }}" class="updating">--.--%</td><td id="dailyPnl-{{ pos.conid }}" class="updating">--.--</td>
                            <td class="holdings-breakdown">
                                {% for acc_id, qty in pos.holdings_breakdown.items() %}
                                    <span>{{ acc_id }}: <strong>{{ qty }}</strong></span>
                                {% endfor %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}<p>当前没有持仓。</p>{% endif %}
    {% endif %}
</div>

{% for account_id, data in all_data.items() %}
    {{ render_account_card(account_id, data) }}
{% else %}
    {% if not aggregated_data %}
    <div class="account-card">
        <h2><i class="fas fa-exclamation-circle"></i> 未能加载数据</h2>
        <p>无法从 IBKR Gateway 获取任何账户信息。</p>
    </div>
    {% endif %}
{% endfor %}
{% endblock %}


{# --- 页面专属的 JavaScript --- #}
{% block scripts %}
<script>
    function updatePnlCell(cell, pnlValue) {
        if (!cell) return;
        let pnlIcon = '';
        if (pnlValue > 0.001) { cell.className = 'updating pnl-positive'; pnlIcon = '<i class="fas fa-arrow-up pnl-icon"></i>'; } 
        else if (pnlValue < -0.001) { cell.className = 'updating pnl-negative'; pnlIcon = '<i class="fas fa-arrow-down pnl-icon"></i>'; } 
        else { cell.className = 'updating'; pnlIcon = '<i class="fas fa-minus pnl-icon"></i>'; }
        cell.innerHTML = pnlIcon + pnlValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function updatePrices() {
        const allRows = Array.from(document.querySelectorAll('tr[data-conid]'));
        if (allRows.length === 0) return;
        const allConids = [...new Set(allRows.map(row => row.dataset.conid))];
        fetch(`/api/prices?conids=${allConids.join(',')}`)
            .then(response => response.json())
            .then(priceData => {
                const accountDailyPnl = {'all': 0};
                allRows.forEach(row => {
                    const conid = row.dataset.conid;
                    const priceInfo = priceData[conid];
                    if (!priceInfo || isNaN(parseFloat(priceInfo.price))) return;
                    const latestPrice = parseFloat(priceInfo.price);
                    const dailyChange = parseFloat(priceInfo.change);
                    const position = parseFloat(row.dataset.position);
                    const costBasis = parseFloat(row.dataset.costbasis);
                    const accountCard = row.closest('.account-card');
                    const accountId = accountCard.dataset.accountId;

                    const marketValue = latestPrice * position;
                    const unrealizedPnl = marketValue - costBasis;
                    const dailyPnl = isNaN(dailyChange) ? 0 : dailyChange * position;
                    const pnlPercent = (costBasis !== 0) ? (unrealizedPnl / costBasis) * 100 : 0;
                    
                    if (!accountDailyPnl[accountId]) accountDailyPnl[accountId] = 0;
                    accountDailyPnl[accountId] += dailyPnl;
                    if (accountId !== 'all') accountDailyPnl['all'] += dailyPnl;

                    const priceCells = document.querySelectorAll(`#price-${conid}`);
                    const marketValueCells = document.querySelectorAll(`#marketValue-${conid}`);
                    const pnlCells = document.querySelectorAll(`#pnl-${conid}`);
                    const pnlPercentCells = document.querySelectorAll(`#pnlPercent-${conid}`);
                    const dailyPnlCells = document.querySelectorAll(`#dailyPnl-${conid}`);

                    priceCells.forEach(cell => {
                        if (priceInfo.is_close) { cell.innerHTML = `${latestPrice.toFixed(2)} <span class="closing-price-tag">(收盘价)</span>`; cell.classList.add('is-closing-price'); } 
                        else { cell.textContent = latestPrice.toFixed(2); cell.classList.remove('is-closing-price'); }
                        cell.style.backgroundColor = 'var(--highlight-color)';
                        setTimeout(() => { cell.style.backgroundColor = ''; }, 1200);
                    });
                    marketValueCells.forEach(cell => cell.textContent = marketValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                    pnlPercentCells.forEach(cell => {
                        cell.className = unrealizedPnl > 0.001 ? 'pnl-positive' : (unrealizedPnl < -0.001 ? 'pnl-negative' : '');
                        cell.textContent = pnlPercent.toFixed(2) + '%';
                    });
                    pnlCells.forEach(cell => updatePnlCell(cell, unrealizedPnl));
                    dailyPnlCells.forEach(cell => updatePnlCell(cell, dailyPnl));
                });
                for (const [accountId, totalDailyPnl] of Object.entries(accountDailyPnl)) {
                    document.querySelectorAll(`#daily-unrealized-pnl-${accountId}`).forEach(cell => {
                         cell.className = totalDailyPnl > 0.001 ? 'summary-value pnl-positive' : (totalDailyPnl < -0.001 ? 'summary-value pnl-negative' : 'summary-value');
                         cell.textContent = totalDailyPnl.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    });
                }
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            }).catch(error => console.error('更新价格失败:', error));
    }

    function switchAccountView(targetAccountId) {
        document.querySelectorAll('.btn-account').forEach(button => {
            button.classList.toggle('active', button.dataset.targetAccount === targetAccountId);
        });
        document.querySelectorAll('.account-card').forEach(card => {
            card.style.display = (card.dataset.accountId === targetAccountId) ? 'block' : 'none';
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        updatePrices();
        setInterval(updatePrices, 15000);
        document.querySelectorAll('.btn-account').forEach(button => {
            button.addEventListener('click', (event) => {
                const targetId = event.currentTarget.dataset.targetAccount;
                switchAccountView(targetId);
            });
        });
        switchAccountView('all');
    });
</script>
{% endblock %}