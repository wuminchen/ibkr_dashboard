{% extends 'base.html' %}

{# --- 页面主体内容 --- #}
{% block title %}IBKR 高级分析仪表盘{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        padding: 0;
        background-color: #f0f2f5;
    }
    .dashboard-container {
        display: flex;
        height: 100vh;
    }
    /* --- 左侧边栏 --- */
    .sidebar {
        width: 320px;
        background-color: #fff;
        padding: 24px;
        box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }
    .sidebar-header {
        text-align: center;
        margin-bottom: 32px;
    }
    .sidebar-header h1 {
        font-size: 1.5rem;
        color: var(--primary-color);
    }
    .sidebar-header .fas {
        margin-right: 10px;
    }
    .sidebar .account-switcher {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 32px;
    }
    .sidebar .btn-account {
        width: 100%;
        text-align: left;
        border-radius: 6px;
    }
    .summary-section h3 {
        font-size: 1.1rem;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 16px;
    }
    .summary-grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .summary-item {
        border-left: none;
        padding: 0;
    }
    /* --- 右侧主内容区 --- */
    .main-content {
        flex-grow: 1;
        padding: 32px;
        overflow-y: auto;
    }
    .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    .main-header h2 {
        font-size: 2rem;
        margin: 0;
        color: #111;
    }
    .main-header .timestamp {
        font-size: 1rem;
        color: #666;
    }
    /* --- 可视化图表卡片 --- */
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 32px;
    }
    .chart-card {
        background-color: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        height: 350px; 
    }
    .chart-card h4 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.1rem;
        color: #333;
    }
    /* 表格容器样式 */
    .positions-section .account-card {
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        padding: 24px 32px;
        overflow: hidden;
    }
    /* --- 表格排序样式 --- */
    th[data-sortable="true"] { cursor: pointer; position: relative; user-select: none; }
    th[data-sortable="true"]::after { content: ''; position: absolute; right: 8px; top: 50%; margin-top: -8px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; opacity: 0.3; }
    th[data-sortable="true"]:not([data-sort-direction])::after { content: ' \2195'; margin-top: -12px; }
    th[data-sortable="true"][data-sort-direction="asc"]::after { border-bottom: 6px solid #333; opacity: 1; }
    th[data-sortable="true"][data-sort-direction="desc"]::after { border-top: 6px solid #333; opacity: 1; }

    /* --- 红涨绿跌高亮动画 --- */
    @keyframes highlight-red-fade {
        from { background-color: rgba(216, 0, 12, 0.3); } /* 红色背景 */
        to { background-color: transparent; }
    }
    .highlight-up {
        animation: highlight-red-fade 1.5s ease-out;
    }

    @keyframes highlight-green-fade {
        from { background-color: rgba(45, 125, 50, 0.3); } /* 绿色背景 */
        to { background-color: transparent; }
    }
    .highlight-down {
        animation: highlight-green-fade 1.5s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h1><i class="fas fa-chart-pie"></i>分析仪表盘</h1>
        </div>
        <div class="account-switcher">
            <button class="btn-account active" data-target-account="all">所有账户 (聚合)</button>
            {% for account_id in all_data.keys() %}
            <button class="btn-account" data-target-account="{{ account_id }}">{{ account_id }}</button>
            {% endfor %}
        </div>
        <div class="summary-section">
            <h3><i class="fas fa-file-invoice-dollar"></i> 核心指标</h3>
            <div id="summary-view-all" class="summary-grid" data-cash="{{ aggregated_data.summary.cash }}" data-netliq="{{ aggregated_data.summary.net_liquidation }}" data-currency="{{ aggregated_data.summary.currency }}">
                {% if aggregated_data %}
                <div class="summary-item"><span class="summary-label">总净清算价值</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.net_liquidation) }} {{ aggregated_data.summary.currency }}</span></div>
                <div class="summary-item"><span class="summary-label">当日总未实现盈亏</span><span id="daily-unrealized-pnl-all" class="summary-value">--.--</span></div>
                <div class="summary-item"><span class="summary-label">今日总已实现盈亏</span><span class="summary-value {% if aggregated_data.summary.realized_pnl > 0 %}pnl-positive{% elif aggregated_data.summary.realized_pnl < 0 %}pnl-negative{% endif %}">{{ "%.2f"|format(aggregated_data.summary.realized_pnl) }}</span></div>
                <div class="summary-item"><span class="summary-label">总现金余额</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.cash) }}</span></div>
                <div class="summary-item"><span class="summary-label">总购买力</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.buying_power) }}</span></div>
                {% endif %}
            </div>
            {% for account_id, data in all_data.items() %}
            <div id="summary-view-{{ account_id }}" class="summary-grid" style="display: none;" data-cash="{{ data.summary.cash }}" data-netliq="{{ data.summary.net_liquidation }}" data-currency="{{ data.summary.currency }}">
                <div class="summary-item"><span class="summary-label">净清算价值</span><span class="summary-value">{{ "%.2f"|format(data.summary.net_liquidation) }} {{ data.summary.currency }}</span></div>
                <div class="summary-item"><span class="summary-label">当日未实现盈亏</span><span id="daily-unrealized-pnl-{{ account_id }}" class="summary-value">--.--</span></div>
                <div class="summary-item"><span class="summary-label">今日已实现盈亏</span><span class="summary-value {% if data.summary.realized_pnl > 0 %}pnl-positive{% elif data.summary.realized_pnl < 0 %}pnl-negative{% endif %}">{{ "%.2f"|format(data.summary.realized_pnl) }}</span></div>
                <div class="summary-item"><span class="summary-label">现金余额</span><span class="summary-value">{{ "%.2f"|format(data.summary.cash) }}</span></div>
                <div class="summary-item"><span class="summary-label">购买力</span><span class="summary-value">{{ "%.2f"|format(data.summary.buying_power) }}</span></div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="main-content">
        <div class="main-header">
            <h2 id="main-content-title">所有账户 (聚合视图)</h2>
            <p class="timestamp">上次更新: <span id="last-updated">--:--:--</span></p>
        </div>
        <div class="charts-grid">
            <div class="chart-card">
                <h4><i class="fas fa-chart-line"></i> 实时净清算价值 (最近300次更新)</h4>
                <canvas id="net-liq-history-chart"></canvas>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> 盈亏影响 Top 5</h4>
                <canvas id="pnl-barchart"></canvas>
            </div>
        </div>
        <div class="positions-section">
            <div id="table-view-all" class="account-card" data-account-id="all">
                 {% if aggregated_data.positions %}
                <table class="positions-table sortable-table">
                    <thead><tr><th data-sortable="true" data-type="text">产品</th><th data-sortable="true" data-type="text">资产类别</th><th data-sortable="true" data-type="numeric">总数量</th><th data-sortable="true" data-type="numeric">加权平均成本</th><th data-sortable="true" data-type="numeric">总持仓成本</th><th data-sortable="true" data-type="numeric">当前市价</th><th data-sortable="true" data-type="numeric">总市值</th><th data-sortable="true" data-type="numeric">总未实现盈亏</th><th data-sortable="true" data-type="numeric">盈亏 (%)</th><th data-sortable="true" data-type="numeric">当日总盈亏</th><th>持仓分布</th></tr></thead>
                    <tbody>
                        {% for pos in aggregated_data.positions %}
                        <tr data-conid="{{ pos.conid }}" data-position="{{ pos.position }}" data-avgcost="{{ pos.avgCost }}" data-costbasis="{{ pos.costBasis }}" data-assetclass="{{ pos.assetClass }}" data-contractdesc="{{ pos.contractDesc }}">
                            <td><strong>{{ pos.contractDesc }}</strong></td><td>{{ pos.assetClass }}</td><td>{{ pos.position }}</td><td>{{ "%.2f"|format(pos.avgCost) }}</td><td>{{ "%.2f"|format(pos.costBasis) }}</td><td id="price-{{ pos.conid }}" class="updating">--.--</td><td id="marketValue-{{ pos.conid }}" class="updating">--.--</td><td id="pnl-{{ pos.conid }}" class="updating">--.--</td><td id="pnlPercent-{{ pos.conid }}" class="updating">--.--%</td><td id="dailyPnl-{{ pos.conid }}" class="updating">--.--</td>
                            <td class="holdings-breakdown">{% for acc_id, qty in pos.holdings_breakdown.items() %}<span>{{ acc_id }}: <strong>{{ qty }}</strong></span>{% endfor %}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}<p>当前没有持仓。</p>{% endif %}
            </div>
            {% for account_id, data in all_data.items() %}
            <div id="table-view-{{ account_id }}" class="account-card" data-account-id="{{ account_id }}" style="display: none;">
                {% if data.positions %}
                <table class="positions-table sortable-table">
                    <thead><tr><th data-sortable="true" data-type="text">产品</th><th data-sortable="true" data-type="text">资产类别</th><th data-sortable="true" data-type="numeric">数量</th><th data-sortable="true" data-type="numeric">平均成本</th><th data-sortable="true" data-type="numeric">持仓成本</th><th data-sortable="true" data-type="numeric">当前市价</th><th data-sortable="true" data-type="numeric">总市值</th><th data-sortable="true" data-type="numeric">未实现盈亏</th><th data-sortable="true" data-type="numeric">盈亏 (%)</th><th data-sortable="true" data-type="numeric">当日盈亏</th><th>货币</th></tr></thead>
                    <tbody>
                         {% for pos in data.positions %}
                        <tr data-conid="{{ pos.conid }}" data-position="{{ pos.position }}" data-avgcost="{{ pos.avgCost }}" data-costbasis="{{ pos.costBasis }}" data-assetclass="{{ pos.assetClass }}" data-contractdesc="{{ pos.contractDesc }}">
                            <td><strong>{{ pos.contractDesc }}</strong></td><td>{{ pos.assetClass }}</td><td>{{ pos.position }}</td><td>{{ "%.2f"|format(pos.avgCost) }}</td><td>{{ "%.2f"|format(pos.costBasis) }}</td><td id="price-{{ pos.conid }}" class="updating">--.--</td><td id="marketValue-{{ pos.conid }}" class="updating">--.--</td><td id="pnl-{{ pos.conid }}" class="updating">--.--</td><td id="pnlPercent-{{ pos.conid }}" class="updating">--.--%</td><td id="dailyPnl-{{ pos.conid }}" class="updating">--.--</td><td>{{ pos.currency }}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}<p>此账户当前没有持仓。</p>{% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}


{# --- 页面专属的 JavaScript --- #}
{% block scripts %}
<script>
    const UPDATE_INTERVAL_MS = 3000;
    // *** 新增：定义图表预热更新次数 ***
    const CHART_WARMUP_UPDATES = 2; // 忽略前2次更新，从第3次开始显示图表

    let chartInstances = {};
    let netLiqHistory = {};
    const MAX_HISTORY_POINTS = 300;
    let accountDataStore = {};

    function animateValue(element, start, end, duration, suffix = '') {
        if (!element) return;
        
        let target = element;
        if (element.childNodes.length > 1 && element.firstChild.nodeType === 3) {
            target = element.firstChild;
        }

        const initialText = target.textContent.trim().replace(/,/g, '');
        const currentValNumeric = parseFloat(initialText)
        const startVal = (isNaN(currentValNumeric) || start === end) ? start : currentValNumeric;
        
        if (startVal === end) {
            target.textContent = end.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if(suffix) element.innerHTML = target.textContent + suffix;
            return;
        };

        element.classList.remove('highlight-up', 'highlight-down');
        void element.offsetWidth; 

        if (end > startVal) {
            element.classList.add('highlight-up'); 
        } else {
            element.classList.add('highlight-down'); 
        }

        const range = end - startVal;
        let startTime = null;

        function step(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / duration, 1);
            const currentAnimatedVal = startVal + progress * range;
            target.textContent = currentAnimatedVal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if(suffix) {
                 element.innerHTML = target.textContent + " " + suffix;
            }
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        }
        window.requestAnimationFrame(step);
    }
    
    function updatePnlCell(cell, pnlValue, oldPnlValue) {
        if (!cell) return;
        let pnlIcon = '';
        if (pnlValue > 0.001) { cell.className = 'pnl-positive'; pnlIcon = '<i class="fas fa-arrow-up pnl-icon"></i>'; } 
        else if (pnlValue < -0.001) { cell.className = 'pnl-negative'; pnlIcon = '<i class="fas fa-arrow-down pnl-icon"></i>'; } 
        else { cell.className = ''; pnlIcon = '<i class="fas fa-minus pnl-icon"></i>'; }
        
        const valueSpan = cell.querySelector('.pnl-value') || document.createElement('span');
        valueSpan.className = 'pnl-value';
        
        const startValue = oldPnlValue !== undefined ? oldPnlValue : pnlValue;
        animateValue(valueSpan, startValue, pnlValue, 500);

        cell.innerHTML = pnlIcon;
        cell.appendChild(valueSpan);
    }
    
    function updatePrices() {
        const allRows = Array.from(document.querySelectorAll('tr[data-conid]'));
        if (allRows.length === 0) return;
        const allConids = [...new Set(allRows.map(row => row.dataset.conid))];

        fetch(`/api/prices?conids=${allConids.join(',')}`)
            .then(response => response.json())
            .then(priceData => {
                const calculatedData = [];
                const dailyPnlByAccount = {};
                Object.keys(accountDataStore).forEach(accId => dailyPnlByAccount[accId] = 0);

                allRows.forEach(row => {
                    const conid = row.dataset.conid;
                    const priceInfo = priceData[conid];
                    const oldPrice = parseFloat(row.querySelector(`#price-${conid}`).textContent.replace(/,/g, '')) || 0;
                    const latestPrice = (priceInfo && !isNaN(parseFloat(priceInfo.price))) ? parseFloat(priceInfo.price) : oldPrice;
                    const dailyChange = (priceInfo && !isNaN(parseFloat(priceInfo.change))) ? parseFloat(priceInfo.change) : 0;
                    const position = parseFloat(row.dataset.position);
                    const costBasis = parseFloat(row.dataset.costbasis);
                    const marketValue = latestPrice * position;
                    const unrealizedPnl = marketValue - costBasis;
                    const dailyPnl = dailyChange * position;
                    const pnlPercent = (costBasis !== 0) ? (unrealizedPnl / costBasis) * 100 : 0;
                    const accountId = row.closest('.account-card').dataset.accountId;

                    calculatedData.push({
                        row, accountId, contractDesc: row.dataset.contractdesc,
                        oldPrice, latestPrice, marketValue, unrealizedPnl, dailyPnl, pnlPercent
                    });

                    if (dailyPnlByAccount.hasOwnProperty(accountId)) { dailyPnlByAccount[accountId] += dailyPnl; }
                    if (accountId !== 'all') { dailyPnlByAccount['all'] += dailyPnl; }
                });

                calculatedData.forEach(data => {
                    const oldMarketValue = parseFloat(data.row.querySelector(`#marketValue-${data.row.dataset.conid}`).textContent.replace(/,/g, '')) || 0;
                    const oldPnl = parseFloat(data.row.querySelector(`#pnl-${data.row.dataset.conid} .pnl-value`)?.textContent.replace(/,/g, '')) || 0;

                    animateValue(data.row.querySelector(`#price-${data.row.dataset.conid}`), data.oldPrice, data.latestPrice, 500);
                    animateValue(data.row.querySelector(`#marketValue-${data.row.dataset.conid}`), oldMarketValue, data.marketValue, 500);
                    updatePnlCell(data.row.querySelector(`#pnl-${data.row.dataset.conid}`), data.unrealizedPnl, oldPnl);
                    
                    const pnlPercentCell = data.row.querySelector(`#pnlPercent-${data.row.dataset.conid}`);
                    pnlPercentCell.className = data.unrealizedPnl > 0.001 ? 'pnl-positive' : (data.unrealizedPnl < -0.001 ? 'pnl-negative' : '');
                    pnlPercentCell.textContent = data.pnlPercent.toFixed(2) + '%';
                });

                for (const accountId in dailyPnlByAccount) {
                    const pnlSummaryCell = document.querySelector(`#daily-unrealized-pnl-${accountId}`);
                    if (pnlSummaryCell) {
                        const oldPnl = parseFloat(pnlSummaryCell.textContent.replace(/,/g, '')) || 0;
                        animateValue(pnlSummaryCell, oldPnl, dailyPnlByAccount[accountId], 500);
                        pnlSummaryCell.className = dailyPnlByAccount[accountId] > 0.001 ? 'summary-value pnl-positive' : (dailyPnlByAccount[accountId] < -0.001 ? 'summary-value pnl-negative' : 'summary-value');
                    }
                }
                
                const newMarketValuesByAccount = {};
                Object.keys(accountDataStore).forEach(accId => newMarketValuesByAccount[accId] = 0);

                calculatedData.forEach(pos => {
                    if (pos.accountId !== 'all' && newMarketValuesByAccount.hasOwnProperty(pos.accountId)) {
                        newMarketValuesByAccount[pos.accountId] += pos.marketValue;
                    }
                });
                
                let totalMarketValueForAll = 0;
                for (const accId in newMarketValuesByAccount) {
                    if (accId !== 'all') {
                        totalMarketValueForAll += newMarketValuesByAccount[accId];
                    }
                }
                newMarketValuesByAccount['all'] = totalMarketValueForAll;
                
                for (const accountId in newMarketValuesByAccount) {
                    const cash = accountDataStore[accountId].cash || 0;
                    const currency = accountDataStore[accountId].currency || 'USD';
                    const currentNetLiq = newMarketValuesByAccount[accountId] + cash;
                    
                    if (!netLiqHistory[accountId]) netLiqHistory[accountId] = [];
                    netLiqHistory[accountId].push({ time: new Date(), value: currentNetLiq });
                    if (netLiqHistory[accountId].length > MAX_HISTORY_POINTS) {
                        netLiqHistory[accountId].shift();
                    }
                    
                    const summaryValueEl = document.querySelector(`#summary-view-${accountId} .summary-item:first-child .summary-value`);
                    if(summaryValueEl) {
                        const oldNetLiq = parseFloat(summaryValueEl.textContent.replace(/[, ]/g, '').replace(currency, '')) || 0;
                        animateValue(summaryValueEl, oldNetLiq, currentNetLiq, 500, currency);
                    }
                }
                
                const activeAccountId = document.querySelector('.btn-account.active').dataset.targetAccount;
                const chartPnlData = calculatedData
                    .filter(pos => pos.accountId === activeAccountId)
                    .map(pos => ({
                        contractDesc: pos.contractDesc,
                        unrealizedPnl: pos.unrealizedPnl
                    }));
                
                // 传递当前激活账户的历史记录给渲染函数
                renderCharts(chartPnlData, netLiqHistory[activeAccountId] || []);

                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            }).catch(error => {
                console.error('更新价格失败:', error);
            });
    }
    
    // *** 核心修改：图表渲染函数增加 history 参数 ***
    function renderCharts(pnlData, history) {
        // *** 核心修改：将稳定逻辑移到这里 ***
        renderNetLiqHistoryChart(history); 

        const sortedByAbsPnl = [...pnlData].sort((a, b) => Math.abs(b.unrealizedPnl) - Math.abs(a.unrealizedPnl));
        const pnlChartData = sortedByAbsPnl.slice(0, 5);
        renderPnlBarChart(pnlChartData);
    }
    
    // *** 核心修改：净值图表渲染函数，实现预热逻辑 ***
    function renderNetLiqHistoryChart(history) {
        const ctx = document.getElementById('net-liq-history-chart');
        if (!ctx) return;

        // 1. 如果历史记录点数不足，则不渲染或清空图表
        if (history.length <= CHART_WARMUP_UPDATES) {
            if (chartInstances.netLiq) {
                chartInstances.netLiq.data.labels = [];
                chartInstances.netLiq.data.datasets[0].data = [];
                chartInstances.netLiq.update('none');
            }
            return; // 提前退出，不执行渲染
        }

        // 2. 如果点数足够，则截取稳定后的数据用于显示
        const displayHistory = history.slice(CHART_WARMUP_UPDATES);

        // 3. 使用稳定后的数据进行渲染
        if (chartInstances.netLiq) {
            chartInstances.netLiq.data.labels = displayHistory.map(p => p.time.toLocaleTimeString());
            chartInstances.netLiq.data.datasets[0].data = displayHistory.map(p => p.value);
            chartInstances.netLiq.update('none');
        } else {
            chartInstances.netLiq = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: displayHistory.map(p => p.time.toLocaleTimeString()),
                    datasets: [{
                        label: '净清算价值',
                        data: displayHistory.map(p => p.value),
                        borderColor: 'var(--primary-color)',
                        backgroundColor: 'rgba(0, 90, 156, 0.1)',
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    animation: {
                        duration: 400 // 平滑动画
                    },
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            grace: '5%', // 给Y轴顶部和底部留出5%的缓冲空间
                            ticks: { callback: (value) => value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) } 
                        }
                    }
                }
            });
        }
    }

    function renderPnlBarChart(data) {
        const ctx = document.getElementById('pnl-barchart');
        if (!ctx) return;
        
        const labels = data.map(p => p.contractDesc);
        const values = data.map(p => p.unrealizedPnl);
        const bgColors = data.map(p => p.unrealizedPnl >= 0 ? 'rgba(216, 0, 12, 0.7)' : 'rgba(45, 125, 50, 0.7)');

        if (chartInstances.pnl) {
            chartInstances.pnl.data.labels = labels;
            chartInstances.pnl.data.datasets[0].data = values;
            chartInstances.pnl.data.datasets[0].backgroundColor = bgColors;
            chartInstances.pnl.update('none');
        } else {
            chartInstances.pnl = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '未实现盈亏', data: values,
                        backgroundColor: bgColors
                    }]
                },
                options: { 
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: {
                         x: { ticks: { color: (c) => c.tick.value >= 0 ? '#D8000C' : '#2E7D32' }}
                    }
                }
            });
        }
    }

    function switchAccountView(targetAccountId) {
        document.getElementById('main-content-title').textContent = document.querySelector(`.btn-account[data-target-account="${targetAccountId}"]`).textContent;
        document.querySelectorAll('.summary-grid').forEach(grid => grid.style.display = grid.id === `summary-view-${targetAccountId}` ? 'flex' : 'none');
        document.querySelectorAll('.positions-section .account-card').forEach(card => card.style.display = (card.dataset.accountId === targetAccountId) ? 'block' : 'none');
        document.querySelectorAll('.btn-account').forEach(button => button.classList.toggle('active', button.dataset.targetAccount === targetAccountId));
        
        if (chartInstances.netLiq) { chartInstances.netLiq.destroy(); chartInstances.netLiq = null; }
        if (chartInstances.pnl) { chartInstances.pnl.destroy(); chartInstances.pnl = null; }
        
        updatePrices();
    }
    
    function makeTablesSortable() {
        document.querySelectorAll('.sortable-table').forEach(table => {
            let headers = table.querySelectorAll('th[data-sortable="true"]');
            headers.forEach((header, index) => header.addEventListener('click', () => sortColumn(table, index)));
        });
    }

    function sortColumn(table, columnIndex) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const header = table.querySelector(`thead th:nth-child(${columnIndex + 1})`);
        const type = header.dataset.type;
        const currentDirection = header.dataset.sortDirection || 'desc';
        const newDirection = currentDirection === 'desc' ? 'asc' : 'desc';
        table.querySelectorAll('th[data-sortable="true"]').forEach(h => h.removeAttribute('data-sort-direction'));
        header.dataset.sortDirection = newDirection;
        const sortedRows = rows.sort((a, b) => {
            const cellA = a.querySelector(`td:nth-child(${columnIndex + 1})`).textContent.trim();
            const cellB = b.querySelector(`td:nth-child(${columnIndex + 1})`).textContent.trim();
            let valA, valB;
            if (type === 'numeric') {
                valA = parseFloat(cellA.replace(/[,%$]/g, '')) || -Infinity;
                valB = parseFloat(cellB.replace(/[,%$]/g, '')) || -Infinity;
            } else { valA = cellA; valB = cellB; }
            if (valA > valB) return 1; if (valA < valB) return -1; return 0;
        });
        if (newDirection === 'desc') sortedRows.reverse();
        tbody.innerHTML = '';
        sortedRows.forEach(row => tbody.appendChild(row));
    }

    document.addEventListener('DOMContentLoaded', () => {
        // *** 修改：不再预加载初始净值到历史记录中 ***
        document.querySelectorAll('.summary-grid[id^="summary-view-"]').forEach(grid => {
            const accountId = grid.id.replace('summary-view-', '');
            accountDataStore[accountId] = {
                cash: parseFloat(grid.dataset.cash) || 0,
                currency: grid.dataset.currency || 'USD'
            };
            // 初始化空的数组，等待预热
            netLiqHistory[accountId] = [];
        });

        document.querySelectorAll('.btn-account').forEach(button => {
            button.addEventListener('click', (event) => switchAccountView(event.currentTarget.dataset.targetAccount));
        });
        
        makeTablesSortable();
        switchAccountView('all'); 
        setInterval(updatePrices, UPDATE_INTERVAL_MS);
    });
</script>
{% endblock %}