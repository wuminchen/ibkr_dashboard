{% extends 'base.html' %}

{# --- 页面主体内容 --- #}
{% block title %}IBKR 高级分析仪表盘{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<style>
    .dashboard-container {
        display: flex;
        width: 100%;
        height: 100vh;
    }

    /* --- 左侧边栏 --- */
    .sidebar {
        width: 320px;
        background-color: #fff;
        padding: 24px;
        box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        flex-shrink: 0;
        transition: all 0.3s ease;
    }
    .sidebar-header {
        text-align: center;
        margin-bottom: 32px;
    }
    .sidebar-header h1 {
        font-size: 1.5rem;
        color: var(--primary-color);
    }
    .sidebar .account-switcher {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 32px;
    }
    .sidebar .btn-account {
        width: 100%;
        text-align: left;
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        border: 1px solid #ccc;
        background-color: #fff;
        transition: all 0.2s ease-in-out;
    }
    .sidebar .btn-account:hover {
        background-color: #e9ecef;
        border-color: #aaa;
    }
    .sidebar .btn-account.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    .summary-section h3 {
        font-size: 1.1rem;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 16px;
    }
    .summary-grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .summary-item {
        border-left: none;
        padding: 0;
    }
    .summary-value {
        font-size: 1.3em;
    }

    /* --- 右侧主内容区 --- */
    .main-content {
        flex-grow: 1;
        padding: 32px;
        overflow-y: auto;
    }
    .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    .main-header h2 {
        font-size: 2.2rem;
        margin: 0;
        color: #111;
    }
    .main-header .controls {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    .main-header .timestamp {
        font-size: 1rem;
        color: #666;
    }
    .header-btn {
        padding: 8px 16px;
        font-size: 14px;
        border: 1px solid var(--primary-color);
        background-color: white;
        color: var(--primary-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        white-space: nowrap;
    }
    .header-btn:hover {
        background-color: var(--primary-color);
        color: white;
    }
    .header-btn.frozen {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
        color: white;
    }


    /* --- 可视化与表格 --- */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }
    .chart-card {
        background-color: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        height: 350px; 
    }
    .chart-card h4 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.1rem;
        color: #333;
    }
    .positions-section .account-card {
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        padding: 24px 32px;
        overflow-x: auto;
    }
    .positions-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 15px;
    }
    .positions-table thead th {
        font-size: 0.9em;
        padding: 12px 10px;
    }
    .positions-table th, .positions-table td {
        padding: 14px 10px;
        border-bottom: 1px solid var(--border-color);
        text-align: left;
        vertical-align: middle;
        white-space: nowrap;
    }

    /* --- 表格排序和高亮动画样式 --- */
    th[data-sortable="true"] { cursor: pointer; position: relative; user-select: none; }
    th[data-sortable="true"]::after { content: ''; position: absolute; right: 8px; top: 50%; margin-top: -8px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; opacity: 0.3; }
    th[data-sortable="true"]:not([data-sort-direction])::after { content: ' \2195'; margin-top: -12px; }
    th[data-sortable="true"][data-sort-direction="asc"]::after { border-bottom: 6px solid #333; opacity: 1; }
    th[data-sortable="true"][data-sort-direction="desc"]::after { border-top: 6px solid #333; opacity: 1; }
    
    /* 单元格内数值跳动动画 */
    @keyframes highlight-red-fade {
        from { background-color: rgba(216, 0, 12, 0.3); }
        to { background-color: transparent; }
    }
    .highlight-up { animation: highlight-red-fade 1.5s ease-out; }
    @keyframes highlight-green-fade {
        from { background-color: rgba(45, 125, 50, 0.3); }
        to { background-color: transparent; }
    }
    .highlight-down { animation: highlight-green-fade 1.5s ease-out; }

    /* 整行闪烁动画 */
    @keyframes highlight-row-fade {
        from { background-color: rgba(255, 229, 100, 0.4); } /* 修改为中性的黄色高亮 */
        to { background-color: transparent; }
    }
    .row-highlight {
        animation: highlight-row-fade 1.5s ease-out;
    }


    /* --- 响应式设计核心 --- */
    @media (max-width: 1024px) {
        body {
             height: auto;
             overflow-y: auto;
        }
        .dashboard-container {
            flex-direction: column;
            height: auto;
        }
        .sidebar {
            width: 100%;
            height: auto;
            box-sizing: border-box;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 24px;
            overflow-y: visible;
        }
        .main-content {
            overflow-y: visible;
            padding: 0 24px 32px;
        }
    }
    @media (max-width: 768px) {
        .sidebar { padding: 16px; }
        .main-content { padding: 0 16px 16px; }
        .positions-section .account-card { padding: 16px; }
        .main-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
        .main-header h2 { font-size: 1.8rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h1><i class="fas fa-chart-pie"></i>分析仪表盘</h1>
        </div>
        <div class="account-switcher">
            <button class="btn-account active" data-target-account="all">所有账户 (聚合)</button>
            {% for account_id in all_data.keys() %}
            <button class="btn-account" data-target-account="{{ account_id }}">{{ account_id }}</button>
            {% endfor %}
        </div>
        <div class="summary-section">
            <h3><i class="fas fa-file-invoice-dollar"></i> 核心指标</h3>
            <div id="summary-view-all" class="summary-grid" data-cash="{{ aggregated_data.summary.cash }}" data-netliq="{{ aggregated_data.summary.net_liquidation }}" data-currency="{{ aggregated_data.summary.currency }}">
                {% if aggregated_data %}
                <div class="summary-item"><span class="summary-label">总净清算价值</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.net_liquidation) }} {{ aggregated_data.summary.currency }}</span></div>
                <div class="summary-item"><span class="summary-label">当日总未实现盈亏</span><span id="daily-unrealized-pnl-all" class="summary-value">--.--</span></div>
                <div class="summary-item"><span class="summary-label">今日总已实现盈亏</span><span class="summary-value {% if aggregated_data.summary.realized_pnl > 0 %}pnl-positive{% elif aggregated_data.summary.realized_pnl < 0 %}pnl-negative{% endif %}">{{ "%.2f"|format(aggregated_data.summary.realized_pnl) }}</span></div>
                <div class="summary-item"><span class="summary-label">总现金余额</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.cash) }}</span></div>
                <div class="summary-item"><span class="summary-label">总购买力</span><span class="summary-value">{{ "%.2f"|format(aggregated_data.summary.buying_power) }}</span></div>
                {% endif %}
            </div>
            {% for account_id, data in all_data.items() %}
            <div id="summary-view-{{ account_id }}" class="summary-grid" style="display: none;" data-cash="{{ data.summary.cash }}" data-netliq="{{ data.summary.net_liquidation }}" data-currency="{{ data.summary.currency }}">
                <div class="summary-item"><span class="summary-label">净清算价值</span><span class="summary-value">{{ "%.2f"|format(data.summary.net_liquidation) }} {{ data.summary.currency }}</span></div>
                <div class="summary-item"><span class="summary-label">当日未实现盈亏</span><span id="daily-unrealized-pnl-{{ account_id }}" class="summary-value">--.--</span></div>
                <div class="summary-item"><span class="summary-label">今日已实现盈亏</span><span class="summary-value {% if data.summary.realized_pnl > 0 %}pnl-positive{% elif data.summary.realized_pnl < 0 %}pnl-negative{% endif %}">{{ "%.2f"|format(data.summary.realized_pnl) }}</span></div>
                <div class="summary-item"><span class="summary-label">现金余额</span><span class="summary-value">{{ "%.2f"|format(data.summary.cash) }}</span></div>
                <div class="summary-item"><span class="summary-label">购买力</span><span class="summary-value">{{ "%.2f"|format(data.summary.buying_power) }}</span></div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="main-content">
        <div class="main-header">
            <h2 id="main-content-title">所有账户 (聚合视图)</h2>
            <div class="controls">
                <button id="freeze-btn" class="header-btn"><i class="fas fa-pause"></i> 冻结界面</button>
                <p class="timestamp">上次更新: <span id="last-updated">--:--:--</span></p>
            </div>
        </div>
        <div class="charts-grid">
            <div class="chart-card">
                <h4><i class="fas fa-chart-line"></i> 实时净清算价值 (最近300次更新)</h4>
                <canvas id="net-liq-history-chart"></canvas>
            </div>
            <div class="chart-card">
                <h4><i class="fas fa-chart-bar"></i> 当日盈亏排行 Top 5</h4>
                <canvas id="pnl-barchart"></canvas>
            </div>
            <div class="chart-card" id="historical-pnl-card" style="display: none;">
                <h4><i class="fas fa-chart-simple"></i> 调整后每日回报率 (TWR)</h4>
                <canvas id="historical-pnl-chart"></canvas>
            </div>
        </div>
        <div class="positions-section">
            <div id="table-view-all" class="account-card" data-account-id="all">
                 {% if aggregated_data.positions %}
                <table class="positions-table sortable-table">
                    <thead><tr><th data-sortable="true" data-type="text">产品</th><th data-sortable="true" data-type="text">资产类别</th><th data-sortable="true" data-type="numeric">总数量</th><th data-sortable="true" data-type="numeric">加权平均成本</th><th data-sortable="true" data-type="numeric">总持仓成本</th><th data-sortable="true" data-type="numeric">当前市价</th><th data-sortable="true" data-type="numeric">总市值</th><th data-sortable="true" data-type="numeric">总未实现盈亏</th><th data-sortable="true" data-type="numeric">盈亏 (%)</th><th data-sortable="true" data-type="numeric">股价变化 (%)</th><th data-sortable="true" data-type="numeric">当日总盈亏</th><th>持仓分布</th></tr></thead>
                    <tbody>
                        {% for pos in aggregated_data.positions %}
                        <tr data-conid="{{ pos.conid }}" data-position="{{ pos.position }}" data-avgcost="{{ pos.avgCost }}" data-costbasis="{{ pos.costBasis }}" data-assetclass="{{ pos.assetClass }}" data-contractdesc="{{ pos.contractDesc }}">
                            <td><strong>{{ pos.contractDesc }}</strong></td><td>{{ pos.assetClass }}</td><td>{{ pos.position }}</td><td>{{ "%.2f"|format(pos.avgCost) }}</td><td>{{ "%.2f"|format(pos.costBasis) }}</td><td id="price-{{ pos.conid }}" class="updating">--.--</td><td id="marketValue-{{ pos.conid }}" class="updating">--.--</td><td id="pnl-{{ pos.conid }}" class="updating">--.--</td><td id="pnlPercent-{{ pos.conid }}" class="updating">--.--%</td><td id="priceChangePercent-{{ pos.conid }}" class="updating">--.--%</td><td id="dailyPnl-{{ pos.conid }}" class="updating">--.--</td>
                            <td class="holdings-breakdown">{% for acc_id, qty in pos.holdings_breakdown.items() %}<span>{{ acc_id }}: <strong>{{ qty }}</strong></span>{% endfor %}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}<p>当前没有持仓。</p>{% endif %}
            </div>
            {% for account_id, data in all_data.items() %}
            <div id="table-view-{{ account_id }}" class="account-card" data-account-id="{{ account_id }}" style="display: none;">
                {% if data.positions %}
                <table class="positions-table sortable-table">
                    <thead><tr><th data-sortable="true" data-type="text">产品</th><th data-sortable="true" data-type="text">资产类别</th><th data-sortable="true" data-type="numeric">数量</th><th data-sortable="true" data-type="numeric">平均成本</th><th data-sortable="true" data-type="numeric">持仓成本</th><th data-sortable="true" data-type="numeric">当前市价</th><th data-sortable="true" data-type="numeric">总市值</th><th data-sortable="true" data-type="numeric">未实现盈亏</th><th data-sortable="true" data-type="numeric">盈亏 (%)</th><th data-sortable="true" data-type="numeric">股价变化 (%)</th><th data-sortable="true" data-type="numeric">当日盈亏</th><th>货币</th></tr></thead>
                    <tbody>
                         {% for pos in data.positions %}
                        <tr data-conid="{{ pos.conid }}" data-position="{{ pos.position }}" data-avgcost="{{ pos.avgCost }}" data-costbasis="{{ pos.costBasis }}" data-assetclass="{{ pos.assetClass }}" data-contractdesc="{{ pos.contractDesc }}">
                            <td><strong>{{ pos.contractDesc }}</strong></td><td>{{ pos.assetClass }}</td><td>{{ pos.position }}</td><td>{{ "%.2f"|format(pos.avgCost) }}</td><td>{{ "%.2f"|format(pos.costBasis) }}</td><td id="price-{{ pos.conid }}" class="updating">--.--</td><td id="marketValue-{{ pos.conid }}" class="updating">--.--</td><td id="pnl-{{ pos.conid }}" class="updating">--.--</td><td id="pnlPercent-{{ pos.conid }}" class="updating">--.--%</td><td id="priceChangePercent-{{ pos.conid }}" class="updating">--.--%</td><td id="dailyPnl-{{ pos.conid }}" class="updating">--.--</td><td>{{ pos.currency }}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}<p>此账户当前没有持仓。</p>{% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}


{# --- 页面专属的 JavaScript --- #}
{% block scripts %}
<script>
    // 接收从后端预加载的所有账户的历史数据
    const preloadedHistoricalData = {{ historical_data_json|safe }};

    const UPDATE_INTERVAL_MS = 3000;
    const CHART_WARMUP_UPDATES = 2;

    let isUiFrozen = false; 
    let chartInstances = {};
    let netLiqHistory = {};
    const MAX_HISTORY_POINTS = 300;
    let accountDataStore = {};

    function animateValue(element, start, end, duration, suffix = '') {
        if (!element) return;
        
        let target = element;
        if (element.childNodes.length > 1 && element.firstChild.nodeType === 3) {
            target = element.firstChild;
        }

        const initialText = target.textContent.trim().replace(/,/g, '');
        const currentValNumeric = parseFloat(initialText)
        const startVal = (isNaN(currentValNumeric) || start === end) ? start : currentValNumeric;
        
        if (startVal === end) {
            let formattedEnd = end.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            let content = suffix ? formattedEnd + " " + suffix : formattedEnd;
            if (element.innerHTML !== content) element.innerHTML = content;
            return;
        };

        element.classList.remove('highlight-up', 'highlight-down');
        void element.offsetWidth; 

        if (end > startVal) {
            element.classList.add('highlight-up'); 
        } else {
            element.classList.add('highlight-down'); 
        }

        const range = end - startVal;
        let startTime = null;

        function step(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / duration, 1);
            const currentAnimatedVal = startVal + progress * range;
            let formattedVal = currentAnimatedVal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
             if(suffix) {
                 element.innerHTML = formattedVal + " " + suffix;
            } else {
                target.textContent = formattedVal;
            }
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        }
        window.requestAnimationFrame(step);
    }
    
    function updatePnlCell(cell, pnlValue, oldPnlValue) {
        if (!cell) return;
        let pnlIcon = '';
        if (pnlValue > 0.001) { cell.className = 'pnl-positive'; pnlIcon = '<i class="fas fa-arrow-up pnl-icon"></i>'; } 
        else if (pnlValue < -0.001) { cell.className = 'pnl-negative'; pnlIcon = '<i class="fas fa-arrow-down pnl-icon"></i>'; } 
        else { cell.className = ''; pnlIcon = '<i class="fas fa-minus pnl-icon"></i>'; }
        
        let valueSpan = cell.querySelector('.pnl-value');
        if (!valueSpan) {
            valueSpan = document.createElement('span');
            valueSpan.className = 'pnl-value';
            cell.innerHTML = pnlIcon; 
            cell.appendChild(valueSpan);
        } else {
            cell.firstChild.outerHTML = pnlIcon; 
        }
        
        const startValue = oldPnlValue !== undefined ? oldPnlValue : pnlValue;
        animateValue(valueSpan, startValue, pnlValue, 500);
    }

    function updatePercentageCell(cell, value) {
        if (!cell) return;
        let icon = '';
        let className = '';
        if (value > 0.001) {
            className = 'pnl-positive';
            icon = '<i class="fas fa-arrow-up pnl-icon"></i> ';
        } else if (value < -0.001) {
            className = 'pnl-negative';
            icon = '<i class="fas fa-arrow-down pnl-icon"></i> ';
        } else {
            className = '';
            icon = '<i class="fas fa-minus pnl-icon"></i> ';
        }
        cell.className = className;
        cell.innerHTML = icon + value.toFixed(2) + '%';
    }
    
    function updatePrices() {
        const allRows = Array.from(document.querySelectorAll('tr[data-conid]'));
        if (allRows.length === 0) return;
        const allConids = [...new Set(allRows.map(row => row.dataset.conid))];

        fetch(`/api/prices?conids=${allConids.join(',')}`)
            .then(response => response.json())
            .then(priceData => {
                const calculatedData = [];
                const dailyPnlByAccount = {};
                Object.keys(accountDataStore).forEach(accId => dailyPnlByAccount[accId] = 0);

                allRows.forEach(row => {
                    const conid = row.dataset.conid;
                    const priceInfo = priceData[conid];
                    const oldPrice = parseFloat(row.querySelector(`#price-${conid}`).textContent.replace(/,/g, '')) || 0;
                    const latestPrice = (priceInfo && !isNaN(parseFloat(priceInfo.price))) ? parseFloat(priceInfo.price) : oldPrice;
                    const dailyChange = (priceInfo && !isNaN(parseFloat(priceInfo.change))) ? parseFloat(priceInfo.change) : 0;
                    const position = parseFloat(row.dataset.position);
                    const costBasis = parseFloat(row.dataset.costbasis);
                    const marketValue = latestPrice * position;
                    const unrealizedPnl = marketValue - costBasis;
                    const dailyPnl = dailyChange * position;
                    const pnlPercent = (costBasis !== 0) ? (unrealizedPnl / costBasis) * 100 : 0;
                    const previousClose = latestPrice - dailyChange;
                    const priceChangePercent = (previousClose !== 0) ? (dailyChange / previousClose) * 100 : 0;
                    const accountId = row.closest('.account-card').dataset.accountId;

                    calculatedData.push({
                        row, accountId, conid, contractDesc: row.dataset.contractdesc,
                        latestPrice, marketValue, unrealizedPnl, dailyPnl,
                        pnlPercent, priceChangePercent
                    });

                    if (dailyPnlByAccount.hasOwnProperty(accountId)) { dailyPnlByAccount[accountId] += dailyPnl; }
                    if (accountId !== 'all') { dailyPnlByAccount['all'] += dailyPnl; }
                });

                if (isUiFrozen) {
                    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString() + " (已冻结)";
                    return;
                }
                
                calculatedData.forEach(data => {
                    const oldPrice = parseFloat(data.row.querySelector(`#price-${data.conid}`).textContent.replace(/,/g, '')) || 0;
                    if (Math.abs(data.latestPrice - oldPrice) > 0.001) {
                        data.row.classList.add('row-highlight');
                        setTimeout(() => data.row.classList.remove('row-highlight'), 1500);
                    }
                    
                    animateValue(data.row.querySelector(`#price-${data.conid}`), oldPrice, data.latestPrice, 500);
                    const oldMarketValue = parseFloat(data.row.querySelector(`#marketValue-${data.conid}`).textContent.replace(/,/g, '')) || 0;
                    animateValue(data.row.querySelector(`#marketValue-${data.conid}`), oldMarketValue, data.marketValue, 500);
                    const oldPnl = parseFloat(data.row.querySelector(`#pnl-${data.conid} .pnl-value`)?.textContent.replace(/,/g, '')) || undefined;
                    updatePnlCell(data.row.querySelector(`#pnl-${data.conid}`), data.unrealizedPnl, oldPnl);
                    updatePercentageCell(data.row.querySelector(`#pnlPercent-${data.conid}`), data.pnlPercent);
                    const priceChangePercentCell = data.row.querySelector(`#priceChangePercent-${data.conid}`);
                    if (priceChangePercentCell) updatePercentageCell(priceChangePercentCell, data.priceChangePercent);
                    const oldDailyPnl = parseFloat(data.row.querySelector(`#dailyPnl-${data.conid} .pnl-value`)?.textContent.replace(/,/g, '')) || undefined;
                    updatePnlCell(data.row.querySelector(`#dailyPnl-${data.conid}`), data.dailyPnl, oldDailyPnl);
                });

                for (const accountId in dailyPnlByAccount) {
                    const pnlSummaryCell = document.querySelector(`#daily-unrealized-pnl-${accountId}`);
                    if (pnlSummaryCell) {
                        const oldPnl = parseFloat(pnlSummaryCell.textContent.replace(/,/g, '')) || 0;
                        animateValue(pnlSummaryCell, oldPnl, dailyPnlByAccount[accountId], 500);
                        pnlSummaryCell.className = `summary-value ${dailyPnlByAccount[accountId] > 0.001 ? 'pnl-positive' : (dailyPnlByAccount[accountId] < -0.001 ? 'pnl-negative' : '')}`;
                    }
                }
                
                let newMarketValuesByAccount = Object.keys(accountDataStore).reduce((acc, accId) => ({...acc, [accId]: 0}), {});
                calculatedData.forEach(pos => {
                    if (pos.accountId !== 'all' && newMarketValuesByAccount.hasOwnProperty(pos.accountId)) {
                        newMarketValuesByAccount[pos.accountId] += pos.marketValue;
                    }
                });
                newMarketValuesByAccount['all'] = Object.values(newMarketValuesByAccount).reduce((sum, val) => sum + val, 0);
                
                for (const accountId in newMarketValuesByAccount) {
                    const cash = accountDataStore[accountId]?.cash || 0;
                    const currency = accountDataStore[accountId]?.currency || 'USD';
                    const currentNetLiq = newMarketValuesByAccount[accountId] + cash;
                    
                    if (!netLiqHistory[accountId]) netLiqHistory[accountId] = [];
                    netLiqHistory[accountId].push({ time: new Date(), value: currentNetLiq });
                    if (netLiqHistory[accountId].length > MAX_HISTORY_POINTS) netLiqHistory[accountId].shift();
                    
                    const summaryValueEl = document.querySelector(`#summary-view-${accountId} .summary-item:first-child .summary-value`);
                    if(summaryValueEl) {
                        const oldNetLiq = parseFloat(summaryValueEl.textContent.replace(/[, ]/g, '').replace(currency, '')) || 0;
                        animateValue(summaryValueEl, oldNetLiq, currentNetLiq, 500, currency);
                    }
                }
                
                const activeAccountId = document.querySelector('.btn-account.active').dataset.targetAccount;
                renderCharts(
                    calculatedData.filter(pos => pos.accountId === activeAccountId), 
                    netLiqHistory[activeAccountId] || []
                );
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            }).catch(error => console.error('更新价格失败:', error));
    }
    
    function renderCharts(dailyPnlData, history) {
        renderNetLiqHistoryChart(history); 
        renderPnlBarChart(dailyPnlData);
    }
    
    function renderNetLiqHistoryChart(history) {
        const ctx = document.getElementById('net-liq-history-chart').getContext('2d');
        if (history.length <= CHART_WARMUP_UPDATES) {
            if (chartInstances.netLiq) { chartInstances.netLiq.data.datasets[0].data = []; chartInstances.netLiq.update('none'); }
            return;
        }
        const displayHistory = history.slice(CHART_WARMUP_UPDATES);
        if (chartInstances.netLiq) {
            chartInstances.netLiq.data.labels = displayHistory.map(p => p.time.toLocaleTimeString());
            chartInstances.netLiq.data.datasets[0].data = displayHistory.map(p => p.value);
            chartInstances.netLiq.update('none');
        } else {
            chartInstances.netLiq = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '净清算价值',
                        borderColor: 'var(--primary-color)',
                        backgroundColor: 'rgba(0, 90, 156, 0.1)',
                        fill: true, tension: 0.2, pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { grace: '5%' } },
                    plugins: { legend: { display: false }, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } } }
                }
            });
        }
    }

    function renderPnlBarChart(data) {
        const ctx = document.getElementById('pnl-barchart').getContext('2d');
        const sortedData = [...data].sort((a, b) => a.dailyPnl - b.dailyPnl);
        const losers = sortedData.filter(p => p.dailyPnl < 0).slice(0, 5);
        const gainers = sortedData.filter(p => p.dailyPnl > 0).reverse().slice(0, 5);
        const finalChartData = [...gainers, ...losers];
        const labels = finalChartData.map(p => p.contractDesc);
        const values = finalChartData.map(p => p.dailyPnl);
        const bgColors = finalChartData.map(p => p.dailyPnl >= 0 ? 'rgba(216, 0, 12, 0.7)' : 'rgba(45, 125, 50, 0.7)');

        if (chartInstances.pnl) {
            chartInstances.pnl.data.labels = labels;
            chartInstances.pnl.data.datasets[0].data = values;
            chartInstances.pnl.data.datasets[0].backgroundColor = bgColors;
            chartInstances.pnl.update('none');
        } else {
            chartInstances.pnl = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: '当日盈亏', data: values, backgroundColor: bgColors }] },
                options: { 
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { ticks: { color: c => c.tick.value >= 0 ? '#D8000C' : '#2E7D32' } } }
                }
            });
        }
    }

    function renderHistoricalPnlChart(data) {
        const historicalCard = document.getElementById('historical-pnl-card');
        const ctx = document.getElementById('historical-pnl-chart').getContext('2d');
        if (!data || data.length === 0) { historicalCard.style.display = 'none'; return; }
        
        historicalCard.style.display = 'block';
        const labels = data.map(d => d.date);
        const values = data.map(d => d.twr);
        const bgColors = data.map(d => d.twr >= 0 ? 'rgba(216, 0, 12, 0.7)' : 'rgba(45, 125, 50, 0.7)');

        if (chartInstances.historicalPnl) {
            chartInstances.historicalPnl.data.labels = labels;
            chartInstances.historicalPnl.data.datasets[0].data = values;
            chartInstances.historicalPnl.data.datasets[0].backgroundColor = bgColors;
            chartInstances.historicalPnl.update('none');
        } else {
            chartInstances.historicalPnl = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: '每日回报率 (TWR)', data: values, backgroundColor: bgColors }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                        tooltip: { callbacks: { label: c => `${c.dataset.label || ''}: ${(c.parsed.y * 100).toFixed(2)}%` } }
                    },
                    scales: { y: { ticks: { callback: v => `${(v * 100).toFixed(1)}%` } } }
                }
            });
        }
    }

    function switchAccountView(targetAccountId) {
        document.getElementById('main-content-title').textContent = document.querySelector(`.btn-account[data-target-account="${targetAccountId}"]`).textContent;
        document.querySelectorAll('.summary-grid').forEach(grid => grid.style.display = (grid.id === `summary-view-${targetAccountId}` ? 'flex' : 'none'));
        document.querySelectorAll('.positions-section .account-card').forEach(card => card.style.display = (card.dataset.accountId === targetAccountId ? 'block' : 'none'));
        document.querySelectorAll('.btn-account').forEach(button => button.classList.toggle('active', button.dataset.targetAccount === targetAccountId));
        
        Object.values(chartInstances).forEach(chart => chart?.destroy());
        chartInstances = {};
        
        const historicalCard = document.getElementById('historical-pnl-card');
        if (targetAccountId === 'all') {
            historicalCard.style.display = 'none';
        } else {
            const historicalData = preloadedHistoricalData[targetAccountId];
            if (historicalData) {
                renderHistoricalPnlChart(historicalData);
            } else {
                console.error(`没有找到账户 ${targetAccountId} 的预加载历史数据。`);
                historicalCard.style.display = 'none';
            }
        }
        updatePrices();
    }
    
    function makeTablesSortable() {
        document.querySelectorAll('.sortable-table').forEach(table => {
            table.querySelectorAll('th[data-sortable="true"]').forEach((header, index) => {
                header.addEventListener('click', () => sortColumn(table, index));
            });
        });
    }

    function sortColumn(table, columnIndex) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.rows);
        const header = table.tHead.rows[0].cells[columnIndex];
        const type = header.dataset.type;
        const currentDirection = header.dataset.sortDirection || 'desc';
        const newDirection = currentDirection === 'desc' ? 'asc' : 'desc';
        
        table.querySelectorAll('th[data-sortable="true"]').forEach(h => h.removeAttribute('data-sort-direction'));
        header.dataset.sortDirection = newDirection;

        rows.sort((a, b) => {
            const cellA = a.cells[columnIndex].textContent.trim();
            const cellB = b.cells[columnIndex].textContent.trim();
            let valA = type === 'numeric' ? parseFloat(cellA.replace(/[,%$]/g, '')) || -Infinity : cellA;
            let valB = type === 'numeric' ? parseFloat(cellB.replace(/[,%$]/g, '')) || -Infinity : cellB;
            if (valA > valB) return 1; if (valA < valB) return -1; return 0;
        });

        if (newDirection === 'desc') rows.reverse();
        rows.forEach(row => tbody.appendChild(row));
    }

    document.addEventListener('DOMContentLoaded', () => {

        document.querySelectorAll('.summary-grid[id^="summary-view-"]').forEach(grid => {
            const accountId = grid.id.replace('summary-view-', '');
            accountDataStore[accountId] = {
                cash: parseFloat(grid.dataset.cash) || 0,
                currency: grid.dataset.currency || 'USD'
            };
            netLiqHistory[accountId] = [];
        });

        document.querySelectorAll('.btn-account').forEach(button => {
            button.addEventListener('click', (event) => switchAccountView(event.currentTarget.dataset.targetAccount));
        });

        const freezeBtn = document.getElementById('freeze-btn');
        freezeBtn.addEventListener('click', () => {
            isUiFrozen = !isUiFrozen;
            freezeBtn.innerHTML = isUiFrozen ? '<i class="fas fa-play"></i> 恢复更新' : '<i class="fas fa-pause"></i> 冻结界面';
            freezeBtn.classList.toggle('frozen', isUiFrozen);
            if (!isUiFrozen) {
                console.log('UI un-frozen. Performing immediate update.');
                updatePrices(); 
            }
        });
        
        makeTablesSortable();
        switchAccountView('all'); 
        setInterval(updatePrices, UPDATE_INTERVAL_MS);
    });
</script>
{% endblock %}